<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Building Cache Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <style>
    /* Leaflet container needs explicit height */
    #map { height: 100%; width: 100%; }
    /* Hide Leaflet attribution on small panels */
    .leaflet-control-attribution { font-size: 10px; }
    /* Scrollbar styling */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    /* Progress bar animation */
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    .progress-shimmer {
      background: linear-gradient(90deg, #3b82f6 25%, #60a5fa 50%, #3b82f6 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
    }
    /* City result hover */
    .city-result:hover { background-color: #334155; }
    /* Tab active state */
    .tab-active { background-color: #3b82f6; color: white; }
    .tab-inactive { color: #94a3b8; }
    .tab-inactive:hover { background-color: #1e293b; }
    /* Toast */
    .toast {
      animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 2.7s forwards;
    }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
  </style>
</head>
<body class="bg-slate-950 text-white h-screen flex flex-col overflow-hidden">

  <!-- ============================================================ -->
  <!-- HEADER                                                        -->
  <!-- ============================================================ -->
  <header class="bg-slate-900 border-b border-slate-800 px-5 py-3 flex items-center justify-between flex-shrink-0 z-10">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center text-sm font-bold">B</div>
      <h1 class="text-base font-semibold tracking-tight">Building Cache Manager</h1>
    </div>
    <div id="stats-bar" class="flex items-center gap-5 text-xs text-slate-400">
      <span id="stat-areas">0 areas</span>
      <span id="stat-buildings">0 buildings</span>
      <span id="stat-size">0 MB</span>
    </div>
  </header>

  <!-- ============================================================ -->
  <!-- MAIN LAYOUT                                                   -->
  <!-- ============================================================ -->
  <div class="flex flex-1 overflow-hidden">

    <!-- SIDEBAR -->
    <aside class="w-[380px] bg-slate-900 border-r border-slate-800 flex flex-col overflow-y-auto flex-shrink-0">

      <!-- Mode tabs -->
      <div class="p-4 pb-3">
        <div class="flex rounded-lg bg-slate-800/80 p-1 gap-1">
          <button onclick="setMode('city')" id="tab-city"
            class="flex-1 py-1.5 px-2 rounded-md text-xs font-medium transition-colors tab-active">
            City Search
          </button>
          <button onclick="setMode('gps')" id="tab-gps"
            class="flex-1 py-1.5 px-2 rounded-md text-xs font-medium transition-colors tab-inactive">
            GPS + Radius
          </button>
          <button onclick="setMode('draw')" id="tab-draw"
            class="flex-1 py-1.5 px-2 rounded-md text-xs font-medium transition-colors tab-inactive">
            Draw on Map
          </button>
        </div>
      </div>

      <!-- City search -->
      <div id="city-section" class="px-4 pb-4">
        <label class="block text-xs text-slate-400 mb-1.5">Search for a city or place</label>
        <input type="text" id="city-input"
          placeholder="e.g. Tulsa, OK"
          class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm
                 focus:outline-none focus:border-blue-500 transition-colors"
          oninput="onCityInput(this.value)" />
        <div id="city-results"
          class="hidden mt-1.5 bg-slate-800 rounded-lg border border-slate-700 overflow-hidden max-h-48 overflow-y-auto">
        </div>
      </div>

      <!-- GPS + Radius -->
      <div id="gps-section" class="px-4 pb-4 hidden">
        <div class="grid grid-cols-2 gap-2.5 mb-2.5">
          <div>
            <label class="block text-xs text-slate-400 mb-1">Latitude</label>
            <input type="number" id="gps-lat" step="any" placeholder="36.06"
              class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm
                     focus:outline-none focus:border-blue-500" />
          </div>
          <div>
            <label class="block text-xs text-slate-400 mb-1">Longitude</label>
            <input type="number" id="gps-lon" step="any" placeholder="-95.82"
              class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm
                     focus:outline-none focus:border-blue-500" />
          </div>
        </div>
        <div class="mb-3">
          <label class="block text-xs text-slate-400 mb-1">Radius (km)</label>
          <input type="number" id="gps-radius" value="3" min="0.1" max="50" step="0.1"
            class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm
                   focus:outline-none focus:border-blue-500" />
        </div>
        <button onclick="applyGps()"
          class="w-full bg-blue-600 hover:bg-blue-500 text-white rounded-lg py-2 text-sm font-medium transition-colors">
          Set Area
        </button>
      </div>

      <!-- Draw instructions -->
      <div id="draw-section" class="px-4 pb-4 hidden">
        <p class="text-xs text-slate-400 leading-relaxed">
          Use the <strong class="text-slate-300">rectangle</strong> or
          <strong class="text-slate-300">circle</strong> tool in the top-right
          of the map to select an area to cache.
        </p>
      </div>

      <!-- Divider -->
      <div class="border-t border-slate-800"></div>

      <!-- Estimation -->
      <div id="estimation-section" class="p-4 hidden">
        <h3 class="text-xs font-semibold text-slate-300 uppercase tracking-wider mb-1">Estimated Cache Size</h3>
        <p class="text-[10px] text-slate-500 mb-3">Rough estimate — actual size depends on building density</p>
        <div class="grid grid-cols-3 gap-2 text-center mb-4">
          <div class="bg-slate-800/60 rounded-lg p-2.5">
            <div class="text-[10px] text-slate-500 mb-0.5">Area</div>
            <div id="est-area" class="text-sm font-semibold">—</div>
          </div>
          <div class="bg-slate-800/60 rounded-lg p-2.5">
            <div class="text-[10px] text-slate-500 mb-0.5">Est. Buildings</div>
            <div id="est-buildings" class="text-sm font-semibold">—</div>
          </div>
          <div class="bg-slate-800/60 rounded-lg p-2.5">
            <div class="text-[10px] text-slate-500 mb-0.5">Est. Size</div>
            <div id="est-size" class="text-sm font-semibold">—</div>
          </div>
        </div>

        <!-- Overlap warning -->
        <div id="overlap-warning"
          class="hidden mb-3 bg-amber-900/20 border border-amber-700/40 rounded-lg px-3 py-2 text-xs text-amber-300 leading-relaxed">
        </div>

        <!-- Name -->
        <div class="mb-3">
          <label class="block text-xs text-slate-400 mb-1">Cache Name</label>
          <input type="text" id="cache-name"
            class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm
                   focus:outline-none focus:border-blue-500" />
        </div>

        <!-- Cache button -->
        <button onclick="startCaching()" id="cache-btn"
          class="w-full bg-emerald-600 hover:bg-emerald-500 disabled:opacity-40 disabled:cursor-not-allowed
                 text-white rounded-lg py-2.5 text-sm font-semibold transition-colors">
          Cache This Area
        </button>
      </div>

      <!-- Progress -->
      <div id="progress-section" class="px-4 pb-4 hidden">
        <h3 class="text-xs font-semibold text-slate-300 uppercase tracking-wider mb-2">Caching Progress</h3>
        <div class="w-full bg-slate-800 rounded-full h-2.5 mb-2 overflow-hidden">
          <div id="progress-bar"
            class="h-full rounded-full transition-all duration-300 ease-out progress-shimmer"
            style="width: 0%"></div>
        </div>
        <p id="progress-text" class="text-xs text-slate-400">Waiting…</p>
      </div>

      <!-- Divider -->
      <div class="border-t border-slate-800"></div>

      <!-- Cached areas -->
      <div class="p-4 flex-1 min-h-0">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-xs font-semibold text-slate-300 uppercase tracking-wider">Cached Areas</h3>
          <button onclick="refreshAreas()" class="text-xs text-slate-500 hover:text-slate-300 transition-colors">
            Refresh
          </button>
        </div>
        <div id="cached-areas-list" class="space-y-2">
          <p class="text-xs text-slate-500 italic">No cached areas yet.</p>
        </div>
      </div>
    </aside>

    <!-- MAP -->
    <main class="flex-1 relative">
      <div id="map"></div>
    </main>
  </div>

  <!-- Toast container -->
  <div id="toast-container" class="fixed top-4 right-4 z-[9999] flex flex-col gap-2"></div>

  <!-- ============================================================ -->
  <!-- JAVASCRIPT                                                    -->
  <!-- ============================================================ -->
  <script>
  // =================================================================
  // State
  // =================================================================
  let map, drawnItems, drawControl;
  let currentMode = 'city';
  let currentBbox = null;       // [minLon, minLat, maxLon, maxLat]
  let currentName = '';
  let currentCenter = null;     // {lat, lon}
  let currentRadiusKm = null;
  let selectionLayer = null;    // L.Rectangle or L.Circle on the map
  let cachedAreaLayers = {};    // areaId -> L.Rectangle
  let isCaching = false;

  // =================================================================
  // Map Initialization
  // =================================================================
  function initMap() {
    map = L.map('map', { zoomControl: true }).setView([39.8, -98.5], 4);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
      maxZoom: 19,
    }).addTo(map);

    drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    drawControl = new L.Control.Draw({
      position: 'topright',
      draw: {
        polygon: false,
        polyline: false,
        marker: false,
        circlemarker: false,
        rectangle: {
          shapeOptions: { color: '#3b82f6', weight: 2, fillOpacity: 0.15 },
        },
        circle: {
          shapeOptions: { color: '#3b82f6', weight: 2, fillOpacity: 0.15 },
        },
      },
      edit: { featureGroup: drawnItems, remove: true },
    });

    map.on(L.Draw.Event.CREATED, function (e) {
      drawnItems.clearLayers();
      drawnItems.addLayer(e.layer);

      if (e.layerType === 'rectangle') {
        const b = e.layer.getBounds();
        const bbox = [b.getWest(), b.getSouth(), b.getEast(), b.getNorth()];
        const center = b.getCenter();
        setBbox(bbox, 'Custom area', center.lat, center.lng, null);
      } else if (e.layerType === 'circle') {
        const c = e.layer.getLatLng();
        const r = e.layer.getRadius(); // meters
        const rKm = r / 1000;
        const bbox = circleToBbox(c.lat, c.lng, rKm);
        setBbox(bbox, `(${c.lat.toFixed(4)}, ${c.lng.toFixed(4)}) ${rKm.toFixed(1)}km`, c.lat, c.lng, rKm);
      }
    });

    map.on(L.Draw.Event.DELETED, function () {
      clearSelection();
    });
  }

  // =================================================================
  // Mode Switching
  // =================================================================
  function setMode(mode) {
    currentMode = mode;
    // Toggle sections
    document.getElementById('city-section').classList.toggle('hidden', mode !== 'city');
    document.getElementById('gps-section').classList.toggle('hidden', mode !== 'gps');
    document.getElementById('draw-section').classList.toggle('hidden', mode !== 'draw');

    // Tabs
    ['city', 'gps', 'draw'].forEach(m => {
      const tab = document.getElementById('tab-' + m);
      if (m === mode) {
        tab.className = tab.className.replace('tab-inactive', 'tab-active');
      } else {
        tab.className = tab.className.replace('tab-active', 'tab-inactive');
      }
    });

    // Draw control
    if (mode === 'draw') {
      map.addControl(drawControl);
    } else {
      try { map.removeControl(drawControl); } catch (_) {}
      drawnItems.clearLayers();
    }

    clearSelection();
  }

  // =================================================================
  // City Search (Nominatim)
  // =================================================================
  let searchTimeout;
  function onCityInput(value) {
    clearTimeout(searchTimeout);
    const q = value.trim();
    if (q.length < 2) {
      document.getElementById('city-results').classList.add('hidden');
      return;
    }
    searchTimeout = setTimeout(() => searchCity(q), 350);
  }

  function searchCity(query) {
    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=6&addressdetails=1`;
    fetch(url)
      .then(r => r.json())
      .then(results => {
        const container = document.getElementById('city-results');
        if (!results.length) {
          container.innerHTML = '<div class="px-3 py-2 text-xs text-slate-500">No results found.</div>';
          container.classList.remove('hidden');
          return;
        }
        container.innerHTML = results.map((r, i) => `
          <div class="city-result px-3 py-2 cursor-pointer text-sm border-b border-slate-700/50 last:border-0 transition-colors"
               onclick='selectCity(${JSON.stringify(r).replace(/'/g, "&#39;")})'>
            <div class="text-slate-200 text-xs">${escHtml(r.display_name)}</div>
            <div class="text-[10px] text-slate-500 mt-0.5">${r.type} &middot; ${r.boundingbox ? 'has bbox' : 'no bbox'}</div>
          </div>
        `).join('');
        container.classList.remove('hidden');
      })
      .catch(() => {
        showToast('Nominatim search failed', 'error');
      });
  }

  function selectCity(result) {
    document.getElementById('city-results').classList.add('hidden');
    document.getElementById('city-input').value = result.display_name;

    if (result.boundingbox) {
      // Nominatim: [south, north, west, east]
      const south = parseFloat(result.boundingbox[0]);
      const north = parseFloat(result.boundingbox[1]);
      const west  = parseFloat(result.boundingbox[2]);
      const east  = parseFloat(result.boundingbox[3]);
      const bbox  = [west, south, east, north];
      const cLat  = (south + north) / 2;
      const cLon  = (west + east) / 2;

      map.fitBounds([[south, west], [north, east]], { padding: [20, 20] });
      setBbox(bbox, result.display_name.split(',')[0].trim(), cLat, cLon, null);
    }
  }

  // =================================================================
  // GPS + Radius
  // =================================================================
  function applyGps() {
    const lat = parseFloat(document.getElementById('gps-lat').value);
    const lon = parseFloat(document.getElementById('gps-lon').value);
    const rKm = parseFloat(document.getElementById('gps-radius').value);
    if (isNaN(lat) || isNaN(lon) || isNaN(rKm)) {
      showToast('Please fill in all fields', 'error');
      return;
    }
    if (lat < -90 || lat > 90 || lon < -180 || lon > 180) {
      showToast('Invalid coordinates', 'error');
      return;
    }
    const bbox = circleToBbox(lat, lon, rKm);
    const name = `(${lat.toFixed(4)}, ${lon.toFixed(4)}) ${rKm}km`;

    // Fly to area
    const rMeters = rKm * 1000;
    map.fitBounds([
      [bbox[1], bbox[0]],
      [bbox[3], bbox[2]]
    ], { padding: [30, 30] });

    // Draw a circle on the map
    if (selectionLayer) map.removeLayer(selectionLayer);
    selectionLayer = L.circle([lat, lon], {
      radius: rMeters,
      color: '#3b82f6',
      weight: 2,
      fillOpacity: 0.12,
    }).addTo(map);

    setBbox(bbox, name, lat, lon, rKm);
  }

  // =================================================================
  // Bounding Box & Estimation
  // =================================================================
  function setBbox(bbox, name, centerLat, centerLon, radiusKm) {
    currentBbox = bbox;
    currentName = name || 'Unnamed area';
    currentCenter = { lat: centerLat, lon: centerLon };
    currentRadiusKm = radiusKm;

    // Show selection rectangle (unless we already drew a circle for GPS mode)
    if (currentMode !== 'gps' && currentMode !== 'draw') {
      if (selectionLayer) map.removeLayer(selectionLayer);
      selectionLayer = L.rectangle(
        [[bbox[1], bbox[0]], [bbox[3], bbox[2]]],
        { color: '#3b82f6', weight: 2, fillOpacity: 0.12, dashArray: '6 4' }
      ).addTo(map);
    }

    // Calculate estimate (frontend, instant)
    const est = calculateEstimate(bbox);
    showEstimate(est);

    // Check overlaps (backend)
    fetch('/cache/estimate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ bbox }),
    })
    .then(r => r.json())
    .then(data => {
      const warn = document.getElementById('overlap-warning');
      if (data.overlapping_areas && data.overlapping_areas.length > 0) {
        const names = data.overlapping_areas.map(a => `"${a.name}"`).join(', ');
        warn.textContent = `Overlaps with cached area(s): ${names}. Data will be downloaded again.`;
        warn.classList.remove('hidden');
      } else {
        warn.classList.add('hidden');
      }
    })
    .catch(() => {});

    document.getElementById('cache-name').value = currentName;
    document.getElementById('estimation-section').classList.remove('hidden');
  }

  function calculateEstimate(bbox) {
    const [minLon, minLat, maxLon, maxLat] = bbox;
    const centerLat = (minLat + maxLat) / 2;
    const latKm = (maxLat - minLat) * 111.32;
    const lonKm = (maxLon - minLon) * 111.32 * Math.cos(centerLat * Math.PI / 180);
    const areaKm2 = Math.abs(latKm * lonKm);
    const estBuildings = Math.round(areaKm2 * 200);
    const estBytes = estBuildings * 160;
    return { areaKm2, estBuildings, estBytes };
  }

  function showEstimate(est) {
    document.getElementById('est-area').textContent = est.areaKm2 < 1
      ? `${(est.areaKm2 * 1000000).toFixed(0)} m²`
      : `${est.areaKm2.toFixed(1)} km²`;
    document.getElementById('est-buildings').textContent = `~${formatNumber(est.estBuildings)}`;
    document.getElementById('est-size').textContent = formatBytes(est.estBytes);

    // Show a warning for very large areas
    const warn = document.getElementById('overlap-warning');
    if (est.areaKm2 > 10000) {
      warn.textContent = `Area exceeds 10,000 km² — too large to cache. Try a smaller area or use GPS+Radius.`;
      warn.classList.remove('hidden');
      document.getElementById('cache-btn').disabled = true;
    } else if (est.areaKm2 > 1000) {
      warn.textContent = `Large area (~${est.areaKm2.toFixed(0)} km²). Download may take several minutes.`;
      warn.classList.remove('hidden');
      document.getElementById('cache-btn').disabled = false;
    } else {
      document.getElementById('cache-btn').disabled = false;
    }
  }

  function clearSelection() {
    currentBbox = null;
    currentName = '';
    currentCenter = null;
    currentRadiusKm = null;
    if (selectionLayer) {
      map.removeLayer(selectionLayer);
      selectionLayer = null;
    }
    document.getElementById('estimation-section').classList.add('hidden');
    document.getElementById('progress-section').classList.add('hidden');
    document.getElementById('overlap-warning').classList.add('hidden');
  }

  // =================================================================
  // Caching with SSE Progress
  // =================================================================
  function startCaching() {
    if (!currentBbox || isCaching) return;

    const name = document.getElementById('cache-name').value.trim() || currentName;
    isCaching = true;
    document.getElementById('cache-btn').disabled = true;
    document.getElementById('progress-section').classList.remove('hidden');
    document.getElementById('progress-bar').style.width = '0%';
    document.getElementById('progress-text').textContent = 'Starting…';

    fetch('/cache/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        bbox: currentBbox,
        name: name,
        center_lat: currentCenter.lat,
        center_lon: currentCenter.lon,
        radius_km: currentRadiusKm,
      }),
    })
    .then(r => {
      if (!r.ok) {
        return r.json().then(err => { throw new Error(err.detail || `Server error (${r.status})`); });
      }
      return r.json();
    })
    .then(data => {
      const taskId = data.task_id;
      if (!taskId) throw new Error('No task_id returned from server');
      const evtSource = new EventSource(`/cache/progress/${taskId}`);

      evtSource.onmessage = function (event) {
        const info = JSON.parse(event.data);
        document.getElementById('progress-bar').style.width = info.progress + '%';
        document.getElementById('progress-text').textContent = info.message || '';

        if (info.progress >= 100) {
          // Remove shimmer on completion
          document.getElementById('progress-bar').classList.remove('progress-shimmer');
          document.getElementById('progress-bar').style.background =
            info.status === 'error'
              ? '#ef4444'
              : 'linear-gradient(90deg, #3b82f6, #10b981)';
        }

        if (info.status === 'complete' || info.status === 'error') {
          evtSource.close();
          isCaching = false;
          document.getElementById('cache-btn').disabled = false;

          if (info.status === 'complete' && info.area) {
            showToast(info.message, 'success');
            refreshAreas();
          } else if (info.status === 'complete') {
            showToast(info.message || 'No buildings found.', 'info');
          } else {
            showToast('Error: ' + info.message, 'error');
          }

          // Reset progress bar shimmer after a delay
          setTimeout(() => {
            const bar = document.getElementById('progress-bar');
            bar.classList.add('progress-shimmer');
            bar.style.background = '';
          }, 3000);
        }
      };

      evtSource.onerror = function () {
        evtSource.close();
        isCaching = false;
        document.getElementById('cache-btn').disabled = false;
        showToast('Connection to server lost', 'error');
      };
    })
    .catch(err => {
      isCaching = false;
      document.getElementById('cache-btn').disabled = false;
      showToast('Failed to start caching: ' + err.message, 'error');
    });
  }

  // =================================================================
  // Cached Areas Management
  // =================================================================
  function refreshAreas() {
    loadCachedAreas();
  }

  function loadCachedAreas() {
    fetch('/cache/areas')
      .then(r => r.json())
      .then(data => {
        renderCachedAreas(data.areas || []);
        updateStats(data.stats || {});
        renderCachedAreasOnMap(data.areas || []);
      })
      .catch(() => showToast('Failed to load cached areas', 'error'));
  }

  function updateStats(stats) {
    document.getElementById('stat-areas').textContent = `${stats.total_areas || 0} areas`;
    document.getElementById('stat-buildings').textContent = `${formatNumber(stats.total_buildings || 0)} buildings`;
    document.getElementById('stat-size').textContent = `${(stats.total_size_mb || 0).toFixed(1)} MB`;
  }

  function renderCachedAreas(areas) {
    const container = document.getElementById('cached-areas-list');
    if (!areas.length) {
      container.innerHTML = '<p class="text-xs text-slate-500 italic">No cached areas yet.</p>';
      return;
    }
    container.innerHTML = areas.map(a => `
      <div class="bg-slate-800/60 rounded-lg p-3 border border-slate-700/40 hover:border-slate-600/60 transition-colors group"
           onmouseenter="highlightArea('${a.id}')" onmouseleave="unhighlightArea('${a.id}')">
        <div class="flex items-start justify-between mb-1.5">
          <div class="text-sm font-medium text-slate-200 leading-tight pr-2 truncate flex-1">${escHtml(a.name)}</div>
          <button onclick="deleteArea('${a.id}')"
            class="text-slate-600 hover:text-red-400 transition-colors text-xs flex-shrink-0 ml-1 opacity-0 group-hover:opacity-100"
            title="Delete">
            &#x2715;
          </button>
        </div>
        <div class="flex items-center gap-3 text-[11px] text-slate-400">
          <span>${formatNumber(a.building_count)} bldgs</span>
          <span>${formatBytes(a.file_size_bytes)}</span>
          <span>${a.area_km2} km²</span>
        </div>
        <div class="flex items-center gap-3 mt-1 text-[10px] text-slate-500">
          <span>${timeAgo(a.created_at)}</span>
          <button onclick="zoomToArea('${a.id}')" class="text-blue-400 hover:text-blue-300 transition-colors">
            Show on map
          </button>
        </div>
      </div>
    `).join('');

    // Store areas globally for map interactions
    window._cachedAreas = areas;
  }

  function renderCachedAreasOnMap(areas) {
    // Remove old layers
    Object.values(cachedAreaLayers).forEach(l => map.removeLayer(l));
    cachedAreaLayers = {};

    areas.forEach(a => {
      const rect = L.rectangle(
        [[a.bbox[1], a.bbox[0]], [a.bbox[3], a.bbox[2]]],
        {
          color: '#10b981',
          weight: 1.5,
          fillOpacity: 0.06,
          dashArray: '4 3',
          interactive: true,
        }
      ).addTo(map);
      rect.bindTooltip(`${a.name}<br>${formatNumber(a.building_count)} buildings`, {
        className: 'bg-slate-800 text-white text-xs border-slate-700',
      });
      cachedAreaLayers[a.id] = rect;
    });
  }

  function highlightArea(areaId) {
    const layer = cachedAreaLayers[areaId];
    if (layer) {
      layer.setStyle({ fillOpacity: 0.2, weight: 2.5, color: '#34d399' });
    }
  }

  function unhighlightArea(areaId) {
    const layer = cachedAreaLayers[areaId];
    if (layer) {
      layer.setStyle({ fillOpacity: 0.06, weight: 1.5, color: '#10b981' });
    }
  }

  function zoomToArea(areaId) {
    const area = (window._cachedAreas || []).find(a => a.id === areaId);
    if (area) {
      map.fitBounds(
        [[area.bbox[1], area.bbox[0]], [area.bbox[3], area.bbox[2]]],
        { padding: [40, 40] }
      );
    }
  }

  function deleteArea(areaId) {
    if (!confirm('Delete this cached area? This cannot be undone.')) return;
    fetch(`/cache/areas/${areaId}`, { method: 'DELETE' })
      .then(r => {
        if (r.ok) {
          showToast('Area deleted', 'success');
          refreshAreas();
        } else {
          showToast('Failed to delete area', 'error');
        }
      })
      .catch(() => showToast('Failed to delete area', 'error'));
  }

  // =================================================================
  // Utility Functions
  // =================================================================
  function circleToBbox(lat, lon, radiusKm) {
    const R = 6371;
    const angDist = radiusKm / R;
    const latRad = lat * Math.PI / 180;
    const minLat = lat - angDist * (180 / Math.PI);
    const maxLat = lat + angDist * (180 / Math.PI);
    const dLon = Math.asin(Math.sin(angDist) / Math.cos(latRad)) * (180 / Math.PI);
    const minLon = lon - dLon;
    const maxLon = lon + dLon;
    return [minLon, minLat, maxLon, maxLat];
  }

  function formatNumber(n) {
    if (n == null) return '0';
    return n.toLocaleString('en-US');
  }

  function formatBytes(bytes) {
    if (!bytes) return '0 B';
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
  }

  function timeAgo(isoStr) {
    if (!isoStr) return '';
    const diff = (Date.now() - new Date(isoStr).getTime()) / 1000;
    if (diff < 60) return 'just now';
    if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
    if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
    return Math.floor(diff / 86400) + 'd ago';
  }

  function escHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function showToast(message, type) {
    const colors = {
      success: 'bg-emerald-600',
      error: 'bg-red-600',
      info: 'bg-blue-600',
    };
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${colors[type] || colors.info} text-white px-4 py-2.5 rounded-lg shadow-lg text-sm max-w-sm`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  // =================================================================
  // Initialize
  // =================================================================
  document.addEventListener('DOMContentLoaded', () => {
    initMap();
    loadCachedAreas();
  });
  </script>
</body>
</html>
